sub GetItemTemplate { # returns HTML for outputting one item
	WriteLog("GetItemTemplate() begin (pages.pl)");

	# %file(hash for each file)
	# file_path = file path including filename
	# file_hash = git's hash of the file's contents
	# author_key = gpg key of author (if any)
	# add_timestamp = time file was added as unix_time
	# child_count = number of replies
	# display_full_hash = display full hash for file
	# template_name = item/item.template by default
	# remove_token = token to remove (for reply tokens)
	# show_vote_summary = shows item's list and count of tags
	# show_quick_vote = displays quick vote buttons
	# item_title = override title
	# item_statusbar = override statusbar
	# tags_list = comma-separated list of tags the item has
	# is_textart = set <tt><code> tags for the message itself
	# no_permalink = do not link to item's permalink page
	# item_score = item's score

	# show_easyfind = show/hide easyfind words
	# item_type = 'txt' or 'image'
	# vote_return_to = page to redirect user to after voting, either item hash or url
	# trim_long_text = trim text if it is longer than config/number/item_long_threshold

	# get %file hash from supplied parameters
	my %file = %{shift @_};

	my $sourceFileHasGoneAway = 0;

	# verify that referenced file path exists
	if (-e $file{'file_path'}) {
		#cool
	}
	else {
		WriteLog('GetItemTemplate: warning: -e $file{file_path} was FALSE; $file{file_path} = ' . $file{'file_path'});
		$sourceFileHasGoneAway = 1;
	}

	if (1) {
		my $itemHash = $file{'file_hash'}; # file hash/item identifier
		my $gpgKey = $file{'author_key'}; # author's fingerprint

		my $isTextart = 0; # if textart, need extra formatting
		my $isSurvey = 0; # if survey, need extra formatting
		my $isTooLong = 0; # if survey, need extra formatting

		my $alias; # stores author's alias / name
		my $isAdmin = 0; # author is admin? (needs extra styles)

		my $itemType = '';

		my $isSigned; # is signed by user (also if it's a pubkey)
		if ($gpgKey) { # if there's a gpg key, it's signed
			$isSigned = 1;
		} else {
			$isSigned = 0;
		}

		# get formatted/post-processed message for this item
		my $message = GetItemDetokenedMessage($file{'file_hash'}, $file{'file_path'});

		if (!$message) {
			#message is missing, try to find fallback
			WriteLog('GetItemTemplate: warning: $message is empty, trying original source');

			if (!$sourceFileHasGoneAway && -e $file{'file_path'}) {
				#original file still exists
				$message = GetFile($file{'file_path'});

				if ($message) {
					$isTextart = 1;
				} else {
					WriteLog('GetItemTemplate: warning: $message is empty even after getting file contents!');
					$message = '[Message is blank.]';
				}
			} else {
				WriteLog('GetItemTemplate: warning: $sourceFileHasGoneAway is TRUE');
				$message = '[Unable to retrieve message. Source file has gone away.]';
			}
		}

		$message =~ s/\r//g;
		if (GetConfig('admin/expo_site_mode')) {
			#trim signature/header-footer
			if (index($message, "\n-- \n") != -1) {
				$message = substr($message, 0, index($message, "\n-- \n"));
			}
		}

		# WriteLog($message);

		if ($file{'tags_list'}) {
			# if there is a list of tags, check to see if there is a 'textart' tag

			# split the tags list into @itemTags array
			my @itemTags = split(',', $file{'tags_list'});

			# loop through all the tags in @itemTags
			while (scalar(@itemTags)) {
				my $thisTag = pop @itemTags;
				if ($thisTag eq 'textart') {
					$isTextart = 1; # set isTextart to 1 if 'textart' tag is present
				}
				if ($thisTag eq 'survey') {
					$isSurvey = 1; # set $isSurvey to 1 if 'survey' tag is present
				}
				if ($thisTag eq 'toolong') {
					$isTooLong = 1; # set $isTooLong to 1 if 'survey' tag is present
				}
			}
		}

		if ($isTooLong && exists($file{'trim_long_text'}) && $file{'trim_long_text'}) {
			my $itemLongThreshold = GetConfig('number/item_long_threshold') || 1024;

			if (length($message) > $itemLongThreshold) {
				$message = substr($message, 0, $itemLongThreshold) . "\n" . '[...]';
				# if item is long, trim it
			}
		}

		if ($file{'item_type'}) {
			$itemType = $file{'item_type'};
		} else {
			$itemType = 'txt';
		}

		if (!$file{'item_title'}) {
			#hack #todo
			$file{'item_title'} = 'Untitled';
			#$file{'item_title'} = '';
		}

		if ($file{'remove_token'}) {
			# if remove_token is specified, remove it from the message
			WriteLog('GetItemTemplate: $file{\'remove_token\'} = ' . $file{'remove_token'});

			$message =~ s/$file{'remove_token'}//g;
			$message = trim($message);

			#todo there is a #bug here, but it is less significant than the majority of cases
			#  the bug is that it removes the token even if it is not by itself on a single line
			#  this could potentially be mis-used to join together two pieces of a forbidden string
			#todo make it so that post does not need to be trimmed, but extra \n\n after the token is removed
		} else {
			WriteLog('GetItemTemplate: $file{\'remove_token\'} is not set');
		}

		# } elsif ($isSurvey) {
		# 	# if survey, format with text fields for answers
		# 	$message = SurveyForWeb($message);

		if ($isTextart) {
			# if textart, format with extra spacing to preserve character arrangement
			$message = TextartForWeb($message);
		} else {
			# if not textart, just escape html characters
			WriteLog('GetItemTemplate: calling FormatForWeb');
			$message = FormatForWeb($message);
		}

		#if (index($message, "<br>\n--\n<br>\n") > -1) {
		if (GetConfig('html/hide_dashdash_signatures')) { # -- \n
			if (index($message, "<br>-- <br>") != -1) {
				$message =~ s/(.+)<br>-- <br>(.+)/$1<span class=admin><br>\n-- <br>\n$2<\/span>/smi;
				# /s = single-line (changes behavior of . metacharacter to match newlines)
				# /m = multi-line (changes behavior of ^ and $ to work on lines instead of entire file)
				# /i = case-insensitive
			}
		}

		#if ($file{'expand_item_references'}) { #todo this also doesn't do anything
		#if ($file{'item_type'} eq 'image') { #todo this doesn't work
		if (0) {
			# >> \>\> #does not work
			$message =~ s/>>([a-f0-9]{40})/GetItemTemplateFromHash($1)/eg;
		} else {
			# if any references to other items, replace with link to item

			# with name
			#$message =~ s/([a-f0-9]{40})/GetItemHtmlLink($1, DBGetItemAttribute($1, 'name'))/eg;

			# with title
			#$message =~ s/([a-f0-9]{40})/GetItemHtmlLink($1, DBGetItemTitle($1))/eg;

			# just the item id
#xx			$message =~ s/([a-f0-9]{40})/GetItemHtmlLink($1, DBGetItemTitle($1, 16))/eg;

			#$message =~ s/([a-f0-9]{40})//eg;
		}

		if ($itemHash) {
			# what this does is replace [[example]] with
			# tag buttons for all the tags contained in
			# tagset/example
			# keywords for searching: [[johari]] [[tagset]]
			$message =~ s/\[\[([a-z]+)\]\]/GetItemTagButtons($itemHash, $1)/ge;
			# REGEX cheatsheet
			# ================
			# /s = single-line (changes behavior of . metacharacter to match newlines)
			# /m = multi-line (changes behavior of ^ and $ to work on lines instead of entire file)
			# /g = global (all instances)
			# /i = case-insensitive
			# /e = eval
		}

		WriteLog('GetItemTemplate: $message is: ' . $message);

		#hint GetHtmlFilename()
		#todo verify that the items exist before turning them into links,
		# so that we don't end up with broken links
		# can be done here or in the function (return original text if no item)?
		#$message =~ s/([a-f0-9]{40})/GetItemHtmlLink($1)/eg;
		#$message =~ s/([a-f0-9]{40})/GetItemTemplateFromHash($1)/eg;

		# if format_avatars flag is set, replace author keys with avatars
		if ($file{'format_avatars'}) {
			$message =~ s/([A-F0-9]{16})/GetHtmlAvatar($1)/eg;
		}

		if (
			$isSigned
				&&
			IsAdmin($gpgKey)
		) {
			# if item is signed, and the signer is an admin, set $isAdmin = 1
			$isAdmin = 1;
		}

		# escape the alias name for outputting to page
		$alias = HtmlEscape($alias);
		my $fileHash = GetFileHash($file{'file_path'}); # get file's hash

		# initialize $itemTemplate for storing item output
		my $itemTemplate = '';
		{
			#return GetWindowTemplate ($param{'body'}, $param{'title'}, $param{'headings'}, $param{'status'}, $param{'menu'});
			my %windowParams;
			$windowParams{'body'} = GetTemplate('html/item/item.template'); # GetItemTemplate()
			if (GetConfig('admin/expo_site_mode')) { #todo #debug #expo
				$windowParams{'title'} = HtmlEscape($file{'item_name'});
			} else {
				$windowParams{'title'} = HtmlEscape($file{'item_title'});
			}
			$windowParams{'guid'} = substr(sha1_hex($file{'file_hash'}), 0, 8);
			# $windowParams{'headings'} = 'haedigns';

			if ($file{'tags_list'}) {
				my $headings = GetTagsListAsHtmlWithLinks($file{'tags_list'});
				$windowParams{'headings'} = $headings;
				#$windowParams{'headings'} = '<a>#' . join('</a> <a>#', split(',', $file{'tags_list'})) . '</a>';
			} # $file{'tags_list'}


			my $statusBar = '';
			if (GetConfig('admin/expo_site_mode') && !GetConfig('admin/expo_site_edit')) { #expo
				WriteLog('GetItemTemplate: $statusBar expo_site_mode override activated');
				if ($file{'item_title'} =~ m/^http/) {
					my $permalinkHtml = $file{'item_title'};
					$statusBar =~ s/\$permalinkHtml/$permalinkHtml/g;
				}

				if ($file{'no_permalink'}) {
					$statusBar = $file{'item_title'};
				}
			} else {
				$statusBar = GetTemplate('html/item/status_bar.template');

				my $fileHashShort = substr($fileHash, 0, 8);
				$statusBar =~ s/\$fileHashShort/$fileHashShort/g;

				if ($gpgKey) {
					# get author link for this gpg key
					my $authorLink = trim(GetAuthorLink($gpgKey));
					$statusBar =~ s/\$authorLink/$authorLink/g;
				} else {
					# if no author, no $authorLink
					$statusBar =~ s/\$authorLink;//g;
				}
				WriteLog('$statusBar 1.5 = ' . $statusBar);
			}

			if ($file{'item_statusbar'}) {
				$statusBar = $file{'item_statusbar'};
			}

			if ($file{'tags_list'} && index($file{'tags_list'}, 'sponsor') != -1) {
				$statusBar = '<a href="' . $file{'item_title'} . '" target=_blank>' . $file{'item_title'} . '</a>';
			}

#			if (!$statusBar && index($file{'tags_list'}, 'speaker') != -1) {
#				#$statusBar = $file{'item_title'};
#			}
			WriteLog('$statusBar 2 = ' . $statusBar);
			if ($itemType eq 'image') {
				$windowParams{'status'} = $statusBar;
				#$windowParams{'status'} = $statusBar . '<hr>' . GetQuickVoteButtonGroup($file{'file_hash'}, $file{'vote_return_to'});
			} else {
				$windowParams{'status'} = $statusBar;
			}

			#$windowParams{'status'} = GetQuickVoteButtonGroup($file{'file_hash'}, $file{'vote_return_to'});


#			if (GetConfig('admin/expo_site_mode') && !GetConfig('admin/expo_site_edit')) {
#				#todo
#				if ($file{'item_name'} eq 'Information') {
#					WriteLog('GetItemTemplate: expo_site_mode: setting window status to blank');
#					$windowParams{'status'} = '';
#				}
#			}

			if (defined($file{'show_quick_vote'})) {
				$windowParams{'menu'} = GetQuickVoteButtonGroup($file{'file_hash'}, $file{'vote_return_to'});
			}

			$itemTemplate = GetWindowTemplate2(\%windowParams);
			$itemTemplate .= '<replies></replies>';
		}

		# $itemTemplate = str_replace(
		# 	'<span class=more></span>',
		# 	GetWidgetExpand(2, '#'),
		# 	$itemTemplate
		# );#todo fix broken
#
#		my $widgetExpandPlaceholder = '<span class=expand></span>';
#		if (index($itemTemplate, $widgetExpandPlaceholder) != -1) {
#			WriteLog('GetItemTemplate: $widgetExpandPlaceholder found in item: ' . $widgetExpandPlaceholder);
#
#			if (GetConfig('admin/js/enable')) {
#				# js on, insert widget
#
#				my $widgetExpand = GetWidgetExpand(5, GetHtmlFilename($itemHash));
#				$itemTemplate = str_replace(
#					'<span class=expand></span>',
#					'<span class=expand>' .	$widgetExpand .	'</span>',
#					$itemTemplate
#				);
#
#				# $itemTemplate = AddAttributeToTag(
#				# 	$itemTemplate,
#				# 	'a href="/etc.html"', #todo this should link to item itself
#				# 	'onclick',
#				# 	"if (window.ShowAll && this.removeAttribute) { this.removeAttribute('onclick'); return ShowAll(this, this.parentElement.parentElement.parentElement.parentElement.parentElement); } else { return true; }"
#				# );
#			} else {
#				# js off, remove placeholder for widget
#				$itemTemplate = str_replace($widgetExpandPlaceholder, '', $itemTemplate);
#			}
#		} # $widgetExpandPlaceholder

		my $authorUrl; # author's profile url
		my $authorAvatar; # author's avatar
		my $permalinkTxt = $file{'file_path'};

		{
		    #todo still does not work perfectly, this
			# set up $permalinkTxt, which links to the .txt version of the file

			# strip the 'html/' prefix on the file's path, replace with /
			#todo relative links
            my $HTMLDIR = GetDir('html');
			$permalinkTxt =~ s/$HTMLDIR\//\//;
			$permalinkTxt =~ s/^html\//\//;
		}

		# set up $permalinkHtml, which links to the html page for the item
		my $permalinkHtml = '/' . GetHtmlFilename($itemHash);
		#		my $permalinkHtml = '/' . substr($itemHash, 0, 2) . '/' . substr($itemHash, 2) . ".html";
		#		$permalinkTxt =~ s/^\.//;

		my $itemAnchor = substr($fileHash, 0, 8);
		my $itemName; # item's 'name'

		if ($file{'display_full_hash'} && $file{'display_full_hash'} != 0) {
			# if display_full_hash is set, display the item's entire hash for name
			$itemName = $fileHash;
		} else {
			# if display_full_hash is not set, truncate the hash to 8 characters
			#$itemName = substr($fileHash, 0, 8) . '..';
			$itemName = $file{'item_name'};
		}

		my $replyCount = $file{'child_count'};
		my $borderColor = '#' . substr($fileHash, 0, 6); # item's border color
		my $addedTime = DBGetAddedTime($fileHash);
		if (!$addedTime) {
			WriteLog('GetItemTemplate: warning: $addedTime was FALSE');
			$addedTime = 0;
		}
		$addedTime = ceil($addedTime);
		my $addedTimeWidget = GetTimestampWidget($addedTime); #todo optimize
		my $itemTitle = $file{'item_title'};

		{ #todo refactor this to not have title in the template
			if ($file{'item_title'}) {
				my $itemTitle = HtmlEscape($file{'item_title'});
				$itemTemplate =~ s/\$itemTitle/$itemTitle/g;
			} else {
				$itemTemplate =~ s/\$itemTitle/Untitled/g;
			}
		}

		my $itemText = '';
		my $itemClass = '';

		if ($itemType eq 'txt') {
			$itemText = $message; # output for item's message (formatted text)

			if ($isTextart) {
				# if item is textart, add "item-textart" css class
				#todo this may not be necessary anymore
				$itemClass = 'item-textart';

				my $textartContainer = GetTemplate('html/item/container/textart.template');
				$textartContainer =~ s/\$message/$itemText/g;

				$itemText = $textartContainer;
			} else {
				$itemClass = "txt";
			}

			if ($isSigned) {
				# if item is signed, add "signed" css class
				$itemClass .= ' signed';
			}

			if ($isAdmin) {
				# if item is signed by an admin, add "admin" css class
				$itemClass .= ' byadmin';

				my $adminContainer = GetTemplate('html/item/container/admin.template');

				my $colorAdmin = GetThemeColor('admin') || '#c00000';
				$adminContainer =~ s/\$colorAdmin/$colorAdmin/g;

				$adminContainer =~ s/\$message/$itemText/g;

				$itemText = $adminContainer;
			} # $isAdmin
		} # $itemType eq 'txt'

		if ($itemType eq 'image') {
			if (GetConfig('admin/image/enable')) {
				my $imageContainer = '';
				if ($file{'no_permalink'}) {
					$imageContainer = GetTemplate('html/item/container/image.template');
				} else {
					$imageContainer = GetTemplate('html/item/container/image_with_link.template');
				}

				my $imageUrl = "/thumb/thumb_800_$fileHash.gif"; #todo hardcoding no
				my $imageSmallUrl = "/thumb/thumb_42_$fileHash.gif"; #todo hardcoding no
				my $imageAlt = $itemTitle;

				if ($file{'image_large'}) {
				} else {
				}
#				my $imageUrl = "/thumb/squared_800_$fileHash.gif"; #todo hardcoding no
#				my $imageSmallUrl = "/thumb/squared_42_$fileHash.gif"; #todo hardcoding no

				# $imageSmallUrl is a smaller image, used in the "lowsrc" attribute for img tag

				if ($file{'image_large'}) {
					$imageContainer = AddAttributeToTag($imageContainer, 'img', 'width', '800');
				} else {
					if ($file{'item_score'} > 0) {
						$imageUrl = "/thumb/thumb_512_$fileHash.gif"; #todo hardcoding no
					} else {
						$imageUrl = "/thumb/thumb_512_g_$fileHash.gif"; #todo hardcoding no
					}
					$imageContainer = AddAttributeToTag($imageContainer, 'img', 'width', '300');
				}

				$imageContainer =~ s/\$imageUrl/$imageUrl/g;
				$imageContainer =~ s/\$imageSmallUrl/$imageSmallUrl/g;
				$imageContainer =~ s/\$imageAlt/$imageAlt/g;
				$imageContainer =~ s/\$permalinkHtml/$permalinkHtml/g;


				$itemText = $imageContainer;

				$itemClass = 'image';
			} else {
				$itemText = '[image]';
				WriteLog('GetItemTemplate: warning: $itemType eq image, but images disabled');
			}
		} # $itemType eq 'image'

		my $replyLink = $permalinkHtml . '#reply'; #todo this doesn't need the url before #reply if it is on the item's page

		if (GetConfig('admin/expo_site_mode')) {
			# do nothing
		} else {
			if (index($itemText, '$') > -1) {
				# this is a kludge, should be a better solution
				#$itemText = '<code>item text contained disallowed character</code>';
				$itemText =~ s/\$/%/g;
			}
		}

		$itemTemplate =~ s/\$borderColor/$borderColor/g;
		$itemTemplate =~ s/\$itemClass/$itemClass/g;
		$itemTemplate =~ s/\$itemName/$itemName/g;
		$itemTemplate =~ s/\$permalinkTxt/$permalinkTxt/g;
		$itemTemplate =~ s/\$permalinkHtml/$permalinkHtml/g;
		$itemTemplate =~ s/\$itemText/$itemText/g;
		$itemTemplate =~ s/\$fileHash/$fileHash/g;
		$itemTemplate =~ s/\$addedTime/$addedTimeWidget/g;
		$itemTemplate =~ s/\$replyLink/$replyLink/g;
		$itemTemplate =~ s/\$itemAnchor/$itemAnchor/g;

		if ($replyCount) {
			$itemTemplate =~ s/\$replyCount/$replyCount/g;
		} else {
			$itemTemplate =~ s/\$replyCount/0/g;
		}

		# if show_vote_summary is set, show a count of all the tags the item has
		if ($file{'show_vote_summary'}) {
			#this displays the vote summary (tags applied and counts)
			my %voteTotals = DBGetItemVoteTotals($file{'file_hash'});
			my $votesSummary = '';
			foreach my $voteTag (keys %voteTotals) {
				#todo templatize this
				$votesSummary .= "$voteTag (" . $voteTotals{$voteTag} . ")\n";
			}
			if ($votesSummary) {
				$votesSummary .= '<br>';
				#todo templatize
			}
			$itemTemplate =~ s/\$votesSummary/$votesSummary/g;
		} else {
			$itemTemplate =~ s/\$votesSummary//g;
		}

		my $itemFlagButton = '';
		if (defined($file{'vote_return_to'}) && $file{'vote_return_to'}) {
			WriteLog('GetItemTemplate: $file{\'vote_return_to\'} = ' . $file{'vote_return_to'});

			$itemFlagButton = GetItemTagButtons($file{'file_hash'}, 'all', $file{'vote_return_to'}); #todo refactor to take vote totals directly
		} else {
			# WriteLog('GetItemTemplate: $file{\'vote_return_to\'} = ' . $file{'vote_return_to'});

			$itemFlagButton = GetItemTagButtons($file{'file_hash'}, 'all'); #todo refactor to take vote totals directly
		}

		$itemTemplate =~ s/\$itemFlagButton/$itemFlagButton/g;

		WriteLog('GetItemTemplate: return $itemTemplate');

		return $itemTemplate;
	} # (1)

	WriteLog('GetItemTemplate: warning: unreachable reached!');
	return '';
} # GetItemTemplate()
